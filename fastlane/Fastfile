default_platform :ios

platform :ios do
  keychain_name = "ios-build.keychain"
  keychain_password = SecureRandom.base64
  build_number = ENV["BUILD_NUMBER"] ||= "0"
  develop_build_number = "0.0." + build_number
  release_build_number = "1.0." + build_number
  deploygate_api_token = ENV["DEPLOYGATE_API_TOKEN"]
  deploygate_user_name = ENV["DEPLOYGATE_USER_NAME"]
  deploygate_message   = ENV["DEPLOYGATE_MESSAGE"] ||= "今回は特にありません"
  ipa_file = ENV["IPA_FILE"] ||= "ci-sample.ipa"

  before_all do
    setup_circle_ci
  end

  lane :test do
    scan
  end

  lane :build do
    clean_build_artifacts
    increment_build_number(
      build_number: develop_build_number
    )

    match(type: "development")
    ipa_file = gym(
      project: "ci-sample.xcodeproj",
      scheme: "ci-sample",
      configuration: "Debug",
      export_method: "development"
    )
  end

  lane :release_build do
    clean_build_artifacts
    increment_build_number(
      build_number: release_build_number
    )


    # change appstore
    match(type: "adhoc")
    ipa_file = gym(
      project: "ci-sample.xcodeproj",
      scheme: "ci-sample",
      configuration: "Release",
      export_method: "ad-hoc"
    )
  end

  desc "DeployGateにipaファイルをアップロードする"
  lane :upload_deploygate do
    deploygate(
      api_token: deploygate_api_token,
      user: deploygate_user_name,
      ipa: ipa_file,
      message: deploygate_message
    )
  end


  desc "メタデータの更新"
  lane :update_metadata do
    deliver(
      skip_binary_upload: true,
      skip_metadata: false,
      force: true
    )
  end

  desc "リリース処理"
  lane :release do
    deliver(
      submit_for_review: true,
      automatic_release: true,
      force: true,
      skip_binary_upload: false,
      skip_metadata: true
    )
  end


  lane :setup_certificate do
    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      add_to_search_list: true
    )

    import_certificate(
      certificate_path: "travis/dist.p12",
      certificate_password: ENV["KEY_PASSWORD"],
      keychain_name: keychain_name,
      keychain_password: keychain_password
    )
  end
end
